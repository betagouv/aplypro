.stat
  %h2 Répartition géographique des montants des PFMPs
  #map-container{style: "width: 100%; height: 600px;", data: {controller: "map", amounts: @amounts_per_academy.to_json, schoolings: @schoolings_per_academy.to_json}}

:javascript
  const initMap = () => {
    const container = document.getElementById('map-container');
    if (!container || container.hasAttribute('data-initialized')) return;

    container.setAttribute('data-initialized', 'true');
    container.innerHTML = '';

    const width = container.offsetWidth;
    const height = 600;

    const amounts = JSON.parse(container.dataset.amounts);
    const schoolings = JSON.parse(container.dataset.schoolings);
    const maxAmount = Math.max(...Object.values(amounts));
    const maxSchoolings = Math.max(...Object.values(schoolings));

    const colorScale = d3.scaleLinear()
      .domain([0, maxAmount])
      .range(["#bccdff", "#000091"]);

    const strokeScale = d3.scaleLinear()
      .domain([0, maxSchoolings])
      .range([0.5, 2]);

    const strokeColorScale = d3.scaleLinear()
      .domain([0, maxSchoolings])
      .range(["#ffbdbd", "#cd0000"]);

    const svg = d3.select("#map-container")
      .append("svg")
      .attr("width", width)
      .attr("height", height);

    const g = svg.append("g");

    const tooltip = d3.select("#map-container")
      .append("div")
      .attr("class", "tooltip")
      .style("position", "absolute")
      .style("background", "white")
      .style("padding", "5px")
      .style("border-radius", "5px")
      .style("pointer-events", "none")
      .style("display", "none")
      .style("z-index", "1000")
      .style("box-shadow", "0 2px 4px rgba(0,0,0,0.2)");

    const projection = d3.geoMercator()
      .center([2.454071, 46.279229])
      .scale(2000)
      .translate([width / 2, height / 2]);

    const path = d3.geoPath()
      .projection(projection);

    d3.json("/data/metropole.geojson").then(function(geojson) {
      g.selectAll("path")
        .data(geojson.features)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("fill", d => {
          const amount = amounts[d.properties.CODE_ACAD] || 0;
          return colorScale(amount);
        })
        .attr("stroke", d => {
          const schoolingCount = schoolings[d.properties.CODE_ACAD] || 0;
          return strokeColorScale(schoolingCount);
        })
        .attr("stroke-width", d => {
          const schoolingCount = schoolings[d.properties.CODE_ACAD] || 0;
          return strokeScale(schoolingCount);
        })
        .attr("opacity", 0.7)
        .on("mouseover", mouseOver)
        .on("mouseout", mouseOut)
        .on("mousemove", mouseMove);

      function mouseOver(event, d) {
        const amount = amounts[d.properties.CODE_ACAD] || 0;
        const schoolingCount = schoolings[d.properties.CODE_ACAD] || 0;

        d3.select(this)
          .transition()
          .duration(200)
          .attr("fill", "#88fdaa")
          .attr("opacity", 1);

        tooltip
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 10) + "px")
          .style("display", "block")
          .html(`${d.properties.LIBL_ACAD} (${d.properties.CODE_ACAD})<br>${amount.toLocaleString('fr-FR')} €<br>${schoolingCount} scolarités`);
      }

      function mouseOut(event, d) {
        const amount = amounts[d.properties.CODE_ACAD] || 0;

        d3.select(this)
          .transition()
          .duration(200)
          .attr("fill", colorScale(amount))
          .attr("opacity", 0.7);

        tooltip.style("display", "none");
      }

      function mouseMove(event, d) {
        tooltip
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 10) + "px");
      }
    }).catch(function(error) {
      console.error("Error loading the geo file:", error);
    });
  };

  document.addEventListener('turbo:load', initMap);
  document.addEventListener('DOMContentLoaded', initMap);

  document.addEventListener('turbo:before-cache', function() {
    const container = document.getElementById('map-container');
    if (container) {
      container.removeAttribute('data-initialized');
      container.innerHTML = '';
    }
  });
