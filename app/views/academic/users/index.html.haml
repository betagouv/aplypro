%section.fr-container.fr-pb-3w
  %h1.fr-h3 Utilisateurs en établissement - Académie #{Establishment::ACADEMY_LABELS[selected_academy]}

  .fr-mb-3w
    .fr-btns-group.fr-btns-group--inline
      = link_to "Tous", academic_users_path, class: "fr-btn #{params[:role].blank? ? 'fr-btn--secondary' : 'fr-btn--tertiary'}"
      = link_to "Directeurs", academic_users_path(role: :dir), class: "fr-btn #{params[:role] == 'dir' ? 'fr-btn--secondary' : 'fr-btn--tertiary'}"
      = link_to "Habilités", academic_users_path(role: :authorised), class: "fr-btn #{params[:role] == 'authorised' ? 'fr-btn--secondary' : 'fr-btn--tertiary'}"

  - if @users.empty?
    .fr-alert.fr-alert--info
      %p.fr-alert__title Aucun utilisateur trouvé pour cette académie.
  - else
    .fr-table.fr-table--no-caption
      %table
        %caption Liste des utilisateurs de l'académie
        %thead
          %tr
            %th{scope: "col"} Nom
            %th{scope: "col"} Email
            %th{scope: "col"} Rôle(s)
            %th{scope: "col"} Établissement(s)
            %th{scope: "col"} Statut
            %th{scope: "col"} Dernière connexion
        %tbody
          - @users.each do |user|
            %tr
              %td
                %strong= user.name
              %td= user.email
              %td
                - user_roles = user.establishment_user_roles.select { |eur| eur.establishment.academy_code == selected_academy }.map(&:role).uniq
                - if user_roles.include?('dir')
                  %span.fr-badge.fr-badge--blue-ecume Directeur
                - if user_roles.include?('authorised')
                  %span.fr-badge.fr-badge--purple-glycine.fr-ml-1w Habilité
              %td
                - establishments = user.establishments.select { |e| e.academy_code == selected_academy }
                - if establishments.any?
                  %ul.fr-raw-list
                    - establishments.each do |establishment|
                      %li
                        = link_to establishment.name, academic_establishment_path(establishment), class: "fr-link"
                        %br
                        %span.fr-text--xs.fr-text--mention-grey UAI : #{establishment.uai}
                        - if establishment.confirmed_director_id == user.id
                          %span.fr-badge.fr-badge--sm.fr-badge--success.fr-ml-1w Confirmé
                - else
                  %span.fr-text--sm.fr-text--mention-grey Aucun établissement
              %td
                - confirmed_count = user.directed_establishments.select { |e| e.academy_code == selected_academy }.count
                - if confirmed_count > 0
                  %span.fr-badge.fr-badge--success
                    Directeur confirmé (#{confirmed_count})
                - else
                  %span.fr-badge.fr-badge--info
                    Directeur non confirmé
              %td
                - if user.last_sign_in_at
                  = l(user.last_sign_in_at, format: :long)
                - else
                  %span.fr-text--sm.fr-text--mention-grey Jamais connecté

    .fr-mt-3w.d-flex.justify-content-center
      = paginate @users
