%section.fr-container.fr-pb-3w
  %h1.fr-h3 Utilisateurs en établissement - Académie #{Establishment::ACADEMY_LABELS[selected_academy]}

  .fr-mb-3w
    = form_with method: :get, url: academic_users_path, local: true do |form|
      .fr-search-bar{role: "search"}
        = form.label :search, "Recherche", class: "fr-label"
        = form.text_field :search, placeholder: "Rechercher par nom ou email...", value: @search_query, class: "fr-input"
        = form.button "Rechercher", type: "submit", class: "fr-btn", name: nil

  .fr-mb-3w
    .fr-btns-group.fr-btns-group--inline
      = link_to "Tous", academic_users_path(search: @search_query), class: "fr-btn #{params[:role].blank? ? 'fr-btn--secondary' : 'fr-btn--tertiary'}"
      = link_to "Directeurs", academic_users_path(role: :dir, search: @search_query), class: "fr-btn #{params[:role] == 'dir' ? 'fr-btn--secondary' : 'fr-btn--tertiary'}"
      = link_to "Habilités", academic_users_path(role: :authorised, search: @search_query), class: "fr-btn #{params[:role] == 'authorised' ? 'fr-btn--secondary' : 'fr-btn--tertiary'}"

  - if @users.empty?
    .fr-alert.fr-alert--info
      %p.fr-alert__title Aucun utilisateur trouvé pour cette académie.
  - else
    = sortable_table_hint
    .fr-table.fr-table--no-caption
      %table
        %caption Liste des utilisateurs de l'académie
        %thead
          %tr
            %th{scope: "col"}
              = sortable_column_header(column: "name", label: "Nom", path: academic_users_path(role: params[:role], search: @search_query, sort: "name"), current_sort: params[:sort])
            %th{scope: "col"}
              = sortable_column_header(column: "email", label: "Email", path: academic_users_path(role: params[:role], search: @search_query, sort: "email"), current_sort: params[:sort])
            %th{scope: "col"} Rôle(s)
            %th{scope: "col"}
              = sortable_column_header(column: "uai", label: "Établissement(s) / UAI", path: academic_users_path(role: params[:role], search: @search_query, sort: "uai"), current_sort: params[:sort])
            %th{scope: "col"}
              = sortable_column_header(column: "last_sign_in", label: "Dernière connexion", path: academic_users_path(role: params[:role], search: @search_query, sort: "last_sign_in"), current_sort: params[:sort])
        %tbody
          - @users.each do |user|
            - academy_eurs = @academy_eurs_by_user[user.id] || []
            - user_roles = academy_eurs.map(&:role).uniq
            - establishments = academy_eurs.map(&:establishment).uniq
            %tr
              %td
                %strong= user.name
              %td= user.email
              %td
                = user_role_badges(user_roles)
              %td
                - if establishments.any?
                  %ul.fr-raw-list
                    - establishments.each do |establishment|
                      %li
                        = link_to establishment.name, academic_establishment_path(establishment), class: "fr-link", target: "_blank", rel: "noopener"
                        %br
                        %span.fr-text--xs.fr-text--mention-grey UAI : #{establishment.uai}
                        - if establishment.confirmed_director_id == user.id
                          %span.fr-badge.fr-badge--sm.fr-badge--success.fr-ml-1w Confirmé
                - else
                  %span.fr-text--sm.fr-text--mention-grey Aucun établissement
              %td
                - if user.last_sign_in_at
                  = l(user.last_sign_in_at, format: :long)
                - else
                  %span.fr-text--sm.fr-text--mention-grey Jamais connecté

    .fr-mt-3w.d-flex.justify-content-center
      = paginate @users, params: { search: @search_query, role: params[:role], sort: params[:sort] }
