.academic-stats-page
  .fr-container
    .fr-px-3w
      .fr-grid-row.fr-grid-row--gutters
        .fr-col-12.fr-mb-2w
          = link_to t("academic.reports.back_to_index"), academic_reports_path, class: "fr-btn fr-btn--sm fr-btn--tertiary"

      .fr-grid-row.fr-grid-row--gutters
        .fr-col-12
          %h1.fr-h3= "Statistiques globales - Année scolaire #{@current_year} - #{@current_year + 1}"

    .fr-grid-row.fr-grid-row--gutters
      .fr-col-12
        .fr-grid-row.fr-grid-row--gutters.fr-mb-3w
          .fr-col-md-6
            %p.fr-text--sm.fr-mb-2w
              %i.fr-icon-refresh-line.fr-icon--sm
              = "Rapport du #{l(@report.created_at, format: :long)} (id: #{@report.id})"

            = render "report_comparison_form", form_url: global_academic_report_path(@report)
          .fr-col-md-6.fr-text--right
            .fr-btns-group.fr-btns-group--right.fr-btns-group--inline-sm
              = button_to export_academic_report_path(@report), method: :post, class: "fr-btn fr-btn--sm fr-btn--secondary", data: { turbo: false } do
                %i.fr-icon-download-line.fr-icon--sm.fr-mr-1w{"aria-hidden": "true"}
                = t("academic.reports.export_csv")
              = link_to t("academic.reports.academy_view"), academic_report_path(@report, comparison_report_id: params[:comparison_report_id]), class: "fr-btn fr-btn--sm fr-btn--secondary"
              - if @report.previous_report
                = link_to t("academic.reports.previous_report"), global_academic_report_path(@report.previous_report), class: "fr-btn fr-btn--sm fr-btn--secondary"
              - if @report.next_report
                = link_to t("academic.reports.next_report"), global_academic_report_path(@report.next_report), class: "fr-btn fr-btn--sm fr-btn--secondary"
    = render "stats_cards", stats: @global_stats, progressions: @global_stats_progressions

    .fr-grid-row.fr-grid-row--gutters.fr-mt-4w{data: { controller: "establishments-table", "establishments-table-src-value": establishments_table_academic_report_path(@report, view_type: "global") }}
      .fr-col-12
        %button.fr-btn.fr-btn--secondary{type: "button", data: { action: "click->establishments-table#toggle" }}
          %span{data: { "establishments-table-target": "toggleText" }}
            Afficher le détail des établissements

      .fr-col-12.hidden{data: { "establishments-table-target": "wrapper" }}
        = turbo_frame_tag "establishments-table-frame", data: { "establishments-table-target": "frame" } do
          .loading-container{style: "min-height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center;"}
            %i.fr-icon-refresh-line.fr-icon--lg{style: "margin-bottom: 1rem;"}
            %p.fr-text--lg Chargement du détail des établissements...

  .fr-container
    .fr-grid-row.fr-grid-row--gutters.fr-mt-6w
      .fr-col-12
        %h2.fr-h3 Statistiques nationales

    .fr-grid-row.fr-grid-row--gutters.fr-mb-4w
      .fr-col-12
        %h3.fr-h5 Statistiques globales

  .fr-table.fr-table--bordered.stats-table-container
    %table
      %thead
        %tr
          - @global_data.first.each_with_index do |header_value, index|
            - header = @indicators_metadata[index]&.dig(:title) || header_value
            %th{scope: "col"}
              = header
              - if @indicators_metadata[index]&.dig(:tooltip_key)
                %button.fr-ml-1w.fr-p-1w.fr-btn--tooltip.fr-btn{"aria-describedby" => "tooltip-stats-#{index}", type: "button"}
                  %span.fr-tooltip.fr-placement{id: "tooltip-stats-#{index}", role: "tooltip", "aria-hidden" => "true"}
                    = t("tooltips.#{@indicators_metadata[index][:tooltip_key]}")
      %tbody
        %tr
          - @global_data.last.each_with_index do |value, index|
            - indicator_type = @indicators_metadata[index]&.dig(:type)
            %td{style: cell_background_color(value, indicator_type: indicator_type)}= format_stat_value(value, indicator_type: indicator_type)

  .fr-container
    .fr-grid-row.fr-grid-row--gutters.fr-mb-4w
      .fr-col-12
        %h3.fr-h5 Statistiques par BOP

  .fr-table.fr-table--bordered.stats-table-container.stats-table-sticky
    %table
      %thead
        %tr
          - @bops_data.first.each_with_index do |header_value, index|
            - header = index > 0 ? (@indicators_metadata[index - 1]&.dig(:title) || header_value) : format_table_header(header_value)
            %th{scope: "col"}
              = header
              - if index > 0 && @indicators_metadata[index - 1]&.dig(:tooltip_key)
                %button.fr-ml-1w.fr-p-1w.fr-btn--tooltip.fr-btn{"aria-describedby" => "tooltip-bops-#{index}", type: "button"}
                  %span.fr-tooltip.fr-placement{id: "tooltip-bops-#{index}", role: "tooltip", "aria-hidden" => "true"}
                    = t("tooltips.#{@indicators_metadata[index - 1][:tooltip_key]}")
      %tbody
        - @bops_data[1..].each do |row|
          %tr
            - row.each_with_index do |value, index|
              - indicator_type = index > 0 ? @indicators_metadata[index - 1]&.dig(:type) : nil
              %td{style: (index > 0 ? cell_background_color(value, indicator_type: indicator_type) : "")}= format_stat_value(value, indicator_type: indicator_type)

  .fr-container
    .fr-grid-row.fr-grid-row--gutters
      .fr-col-12
        %h3.fr-h5 Statistiques par académie MENJ

  .fr-table.fr-table--bordered.stats-table-container.stats-table-sticky
    %table
      %thead
        %tr
          - @menj_academies_data.first.each_with_index do |header_value, index|
            - header = index > 0 ? (@indicators_metadata[index - 1]&.dig(:title) || header_value) : format_table_header(header_value)
            %th{scope: "col"}
              = header
              - if index > 0 && @indicators_metadata[index - 1]&.dig(:tooltip_key)
                %button.fr-ml-1w.fr-p-1w.fr-btn--tooltip.fr-btn{"aria-describedby" => "tooltip-academies-#{index}", type: "button"}
                  %span.fr-tooltip.fr-placement{id: "tooltip-academies-#{index}", role: "tooltip", "aria-hidden" => "true"}
                    = t("tooltips.#{@indicators_metadata[index - 1][:tooltip_key]}")
      %tbody
        - @menj_academies_data[1..].each do |row|
          %tr
            - row.each_with_index do |value, index|
              - indicator_type = index > 0 ? @indicators_metadata[index - 1]&.dig(:type) : nil
              %td{class: (index == 0 ? "fr-text--bold" : ""), style: (index > 0 ? cell_background_color(value, indicator_type: indicator_type) : "")}= format_stat_value(value, indicator_type: indicator_type)
