.academic-stats-page
  .fr-container
    .fr-px-3w
      .fr-grid-row.fr-grid-row--gutters
        .fr-col-12.fr-mb-2w
          = link_to t("academic.reports.back_to_index"), academic_reports_path, class: "fr-btn fr-btn--sm fr-btn--tertiary"

      .fr-grid-row.fr-grid-row--gutters
        .fr-col-12
          %h1.fr-h3= "Statistiques de l'académie #{Establishment::ACADEMY_LABELS[selected_academy]} (#{selected_academy}) - Année scolaire #{@current_year} - #{@current_year + 1}"

    .fr-grid-row.fr-grid-row--gutters
      .fr-col-12
        .fr-grid-row.fr-grid-row--gutters.fr-mb-3w
          .fr-col-md-6
            %p.fr-text--sm.fr-mb-2w
              %i.fr-icon-refresh-line.fr-icon--sm
              = "Rapport du #{l(@report.created_at, format: :long)} (id: #{@report.id})"

            = render "report_comparison_form", form_url: academic_report_path(@report)
          .fr-col-md-6.fr-text--right
            .fr-btns-group.fr-btns-group--right.fr-btns-group--inline-sm
              - if current_user.admin?
                = link_to global_academic_report_path(@report, comparison_report_id: params[:comparison_report_id]), class: "fr-btn fr-btn--sm fr-btn--secondary" do
                  %i.fr-icon-earth-line.fr-icon--sm.fr-mr-1w{"aria-hidden": "true"}
                  = t("academic.reports.global_view")
                = button_to export_academic_report_path(@report), method: :post, class: "fr-btn fr-btn--sm fr-btn--secondary", data: { turbo: false } do
                  %i.fr-icon-download-line.fr-icon--sm.fr-mr-1w{"aria-hidden": "true"}
                  = t("academic.reports.export_csv")
              - if @report.previous_report
                = link_to t("academic.reports.previous_report"), academic_report_path(@report.previous_report), class: "fr-btn fr-btn--sm fr-btn--secondary"
              - if @report.next_report
                = link_to t("academic.reports.next_report"), academic_report_path(@report.next_report), class: "fr-btn fr-btn--sm fr-btn--secondary"
    = render "stats_cards", stats: @academy_stats, progressions: @academy_stats_progressions

    = render "establishments_table"

  .fr-container
    .fr-grid-row.fr-grid-row--gutters.fr-mt-6w
      .fr-col-12
        %h2.fr-h3 Statistiques nationales

    .fr-grid-row.fr-grid-row--gutters.fr-mb-4w
      .fr-col-12
        %h3.fr-h5 Statistiques globales

  .fr-table.fr-table--bordered.stats-table-container
    %table
      %thead
        %tr
          - visible_columns(@global_data).each do |index|
            - header = @indicators_metadata[index]&.dig(:title) || @global_data.first[index]
            %th{scope: "col"}
              = header
              - if @indicators_metadata[index]&.dig(:tooltip_key)
                %button.fr-ml-1w.fr-p-1w.fr-btn--tooltip.fr-btn{"aria-describedby" => "tooltip-stats-#{index}", type: "button"}
                  %span.fr-tooltip.fr-placement{id: "tooltip-stats-#{index}", role: "tooltip", "aria-hidden" => "true"}
                    = t("tooltips.#{@indicators_metadata[index][:tooltip_key]}")
      %tbody
        %tr
          - visible_columns(@global_data).each do |index|
            - value = @global_data.last[index]
            - indicator_type = @indicators_metadata[index]&.dig(:type)
            %td{style: cell_background_color(value)}= format_stat_value(value, indicator_type: indicator_type)

  .fr-container
    .fr-grid-row.fr-grid-row--gutters.fr-mb-4w
      .fr-col-12
        %h3.fr-h5 Statistiques par BOP

  .fr-table.fr-table--bordered.stats-table-container
    %table
      %thead
        %tr
          - visible_columns(@bops_data).each do |index|
            - header = index > 0 ? (@indicators_metadata[index - 1]&.dig(:title) || @bops_data.first[index]) : format_table_header(@bops_data.first[index])
            %th{scope: "col"}
              = header
              - if index > 0 && @indicators_metadata[index - 1]&.dig(:tooltip_key)
                %button.fr-ml-1w.fr-p-1w.fr-btn--tooltip.fr-btn{"aria-describedby" => "tooltip-bops-#{index}", type: "button"}
                  %span.fr-tooltip.fr-placement{id: "tooltip-bops-#{index}", role: "tooltip", "aria-hidden" => "true"}
                    = t("tooltips.#{@indicators_metadata[index - 1][:tooltip_key]}")
      %tbody
        - @bops_data[1..].each do |row|
          %tr
            - visible_columns(@bops_data).each do |index|
              - value = row[index]
              - indicator_type = index > 0 ? @indicators_metadata[index - 1]&.dig(:type) : nil
              %td{style: (index > 0 ? cell_background_color(value) : "")}= format_stat_value(value, indicator_type: indicator_type)

  .fr-container
    .fr-grid-row.fr-grid-row--gutters
      .fr-col-12
        %h3.fr-h5 Statistiques par académie MENJ

  .fr-table.fr-table--bordered.stats-table-container
    %table
      %thead
        %tr
          - visible_columns(@menj_academies_data).each do |index|
            - header = index > 0 ? (@indicators_metadata[index - 1]&.dig(:title) || @menj_academies_data.first[index]) : format_table_header(@menj_academies_data.first[index])
            %th{scope: "col"}
              = header
              - if index > 0 && @indicators_metadata[index - 1]&.dig(:tooltip_key)
                %button.fr-ml-1w.fr-p-1w.fr-btn--tooltip.fr-btn{"aria-describedby" => "tooltip-academies-#{index}", type: "button"}
                  %span.fr-tooltip.fr-placement{id: "tooltip-academies-#{index}", role: "tooltip", "aria-hidden" => "true"}
                    = t("tooltips.#{@indicators_metadata[index - 1][:tooltip_key]}")
      %tbody
        - @menj_academies_data[1..].each do |row|
          %tr
            - visible_columns(@menj_academies_data).each do |index|
              - value = row[index]
              - indicator_type = index > 0 ? @indicators_metadata[index - 1]&.dig(:type) : nil
              %td{class: (index == 0 ? "fr-text--bold" : ""), style: (index > 0 ? cell_background_color(value) : "")}= format_stat_value(value, indicator_type: indicator_type)
